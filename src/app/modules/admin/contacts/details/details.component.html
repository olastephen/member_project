<div class="flex flex-col w-full">
    <!-- View mode -->
    <ng-container *ngIf="!editMode">
        <!-- Header -->
        <div class="relative w-full h-40 sm:h-48 px-8 sm:px-12 bg-accent-100 dark:bg-accent-700">
            <ng-container *ngIf="contact?.background">
                <img class="absolute inset-0 object-cover w-full h-full" [src]="contact.background">
            </ng-container>
            <div class="flex items-center justify-end w-full max-w-3xl mx-auto pt-6">
                <a mat-icon-button [matTooltip]="'Close'" [routerLink]="['../']">
                    <mat-icon class="text-white" [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
                </a>
            </div>
        </div>
        <div class="relative flex flex-col flex-auto items-center p-6 pt-0 sm:p-12 sm:pt-0">
            <div class="w-full max-w-3xl">
                <div class="flex flex-auto items-end -mt-16">
                    <div class="flex items-center justify-center w-32 h-32 rounded-full overflow-hidden ring-4 ring-bg-card">
                        <img class="object-cover w-full h-full" *ngIf="contact?.avatar" [src]="contact.avatar">
                        <div class="flex items-center justify-center w-full h-full rounded overflow-hidden uppercase text-8xl font-bold leading-none bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-200" *ngIf="!contact?.avatar">
                            {{ contact?.name?.charAt(0) }}
                        </div>
                    </div>
                    <div class="flex items-center ml-auto mb-1">
                        <button mat-stroked-button (click)="toggleEditMode(true)">
                            <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:pencil-square'"></mat-icon>
                            <span class="ml-2">Edit</span>
                        </button>
                    </div>
                </div>
                <div class="mt-3 text-4xl font-bold truncate">{{ contact?.name }}</div>
                <div class="flex flex-wrap items-center mt-2">
                    <ng-container *ngFor="let tag of contact?.tags; trackBy: trackByFn">
                        <div class="flex items-center justify-center py-1 px-3 mr-3 mb-3 rounded-full leading-normal text-gray-500 bg-gray-100 dark:text-gray-300 dark:bg-gray-700">
                            <span class="text-sm font-medium whitespace-nowrap">{{ tag }}</span>
                        </div>
                    </ng-container>
                </div>
                <div class="flex flex-col mt-4 pt-6 border-t space-y-8">
                    <ng-container *ngIf="contact?.job?.title">
                        <div class="flex sm:items-center">
                            <mat-icon [svgIcon]="'heroicons_outline:briefcase'"></mat-icon>
                            <div class="ml-6 leading-6">{{ contact.job.title }}</div>
                        </div>
                    </ng-container>
                    <ng-container *ngIf="contact?.job?.company">
                        <div class="flex sm:items-center">
                            <mat-icon [svgIcon]="'heroicons_outline:building-office-2'"></mat-icon>
                            <div class="ml-6 leading-6">{{ contact.job.company }}</div>
                        </div>
                    </ng-container>
                    <ng-container *ngIf="contact?.emails?.length">
                        <div class="flex">
                            <mat-icon [svgIcon]="'heroicons_outline:envelope'"></mat-icon>
                            <div class="min-w-0 ml-6 space-y-1">
                                <ng-container *ngFor="let email of contact?.emails; trackBy: trackByFn">
                                    <div class="flex items-center leading-6">
                                        <a class="hover:underline text-primary-500" [href]="'mailto:' + email.email" target="_blank">
                                            {{ email.email }}
                                        </a>
                                        <div class="text-md truncate text-secondary" *ngIf="email.label">
                                            <span class="mx-2">&bull;</span>
                                            <span class="font-medium">{{ email.label }}</span>
                                        </div>
                                    </div>
                                </ng-container>
                            </div>
                        </div>
                    </ng-container>
                    <ng-container *ngIf="contact?.phoneNumbers?.length">
                        <div class="flex">
                            <mat-icon [svgIcon]="'heroicons_outline:phone'"></mat-icon>
                            <div class="min-w-0 ml-6 space-y-1">
                                <ng-container *ngFor="let phoneNumber of contact?.phoneNumbers; trackBy: trackByFn">
                                    <div class="flex items-center leading-6">
                                        <div class="ml-2.5 font-mono">{{ phoneNumber.phoneNumber }}</div>
                                        <div class="text-md truncate text-secondary" *ngIf="phoneNumber.label">
                                            <span class="mx-2">&bull;</span>
                                            <span class="font-medium">{{ phoneNumber.label }}</span>
                                        </div>
                                    </div>
                                </ng-container>
                            </div>
                        </div>
                    </ng-container>
                    <ng-container *ngIf="contact?.address">
                        <div class="flex sm:items-center">
                            <mat-icon [svgIcon]="'heroicons_outline:map-pin'"></mat-icon>
                            <div class="ml-6 leading-6">{{ contact.address }}</div>
                        </div>
                    </ng-container>
                    <ng-container *ngIf="contact?.birthday">
                        <div class="flex sm:items-center">
                            <mat-icon [svgIcon]="'heroicons_outline:cake'"></mat-icon>
                            <div class="ml-6 leading-6">{{ contact.birthday | date:'longDate' }}</div>
                        </div>
                    </ng-container>
                    <ng-container *ngIf="contact?.notes">
                        <div class="flex">
                            <mat-icon [svgIcon]="'heroicons_outline:bars-3-bottom-left'"></mat-icon>
                            <div class="max-w-none ml-6 prose prose-sm" [innerHTML]="contact.notes"></div>
                        </div>
                    </ng-container>
                </div>
            </div>
        </div>
    </ng-container>

    <!-- Edit mode -->
    <ng-container *ngIf="editMode">
        <div class="relative w-full h-40 sm:h-48 px-8 sm:px-12 bg-accent-100 dark:bg-accent-700">
            <ng-container *ngIf="contact?.background">
                <img class="absolute inset-0 object-cover w-full h-full" [src]="contact.background">
            </ng-container>
            <div class="flex items-center justify-end w-full max-w-3xl mx-auto pt-6">
                <a mat-icon-button [matTooltip]="'Close'" [routerLink]="['../']">
                    <mat-icon class="text-white" [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
                </a>
            </div>
        </div>
        <div class="relative flex flex-col flex-auto items-center px-6 sm:px-12">
            <div class="w-full max-w-3xl">
                <form [formGroup]="contactForm">
                    <div class="flex flex-auto items-end -mt-16">
                        <div class="relative flex items-center justify-center w-32 h-32 rounded-full overflow-hidden ring-4 ring-bg-card">
                            <div class="absolute inset-0 bg-black bg-opacity-50 z-10"></div>
                            <div class="absolute inset-0 flex items-center justify-center z-20">
                                <div>
                                    <input id="avatar-file-input" class="absolute h-0 w-0 opacity-0 invisible pointer-events-none" type="file" [multiple]="false" [accept]="'image/jpeg, image/png'" (change)="uploadAvatar(avatarFileInput.files)" #avatarFileInput>
                                    <label class="flex items-center justify-center w-10 h-10 rounded-full cursor-pointer hover:bg-hover" for="avatar-file-input" matRipple>
                                        <mat-icon class="text-white" [svgIcon]="'heroicons_outline:camera'"></mat-icon>
                                    </label>
                                </div>
                                <div>
                                    <button mat-icon-button (click)="removeAvatar()">
                                        <mat-icon class="text-white" [svgIcon]="'heroicons_outline:trash'"></mat-icon>
                                    </button>
                                </div>
                            </div>
                            <img class="object-cover w-full h-full" *ngIf="contact?.avatar" [src]="contact.avatar">
                            <div class="flex items-center justify-center w-full h-full rounded overflow-hidden uppercase text-8xl font-bold leading-none bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-200" *ngIf="!contact?.avatar">
                                {{ contact?.name?.charAt(0) }}
                            </div>
                        </div>
                    </div>
                    <div class="mt-8">
                        <mat-form-field class="w-full" [subscriptSizing]="'dynamic'">
                            <mat-label>Name</mat-label>
                            <mat-icon matPrefix class="hidden sm:flex icon-size-5" [svgIcon]="'heroicons_solid:user-circle'"></mat-icon>
                            <input matInput [formControlName]="'name'" [placeholder]="'Name'" [spellcheck]="false">
                        </mat-form-field>
                    </div>
                    <div class="mt-8">
                        <mat-form-field class="w-full" [subscriptSizing]="'dynamic'">
                            <mat-label>Marital Status</mat-label>
                            <mat-icon matPrefix class="hidden sm:flex icon-size-5" [svgIcon]="'heroicons_solid:heart'"></mat-icon>
                            <input matInput [formControlName]="'marital_status'" [placeholder]="'Marital Status'" [spellcheck]="false">
                        </mat-form-field>
                    </div>
                    <div class="mt-8">
                        <mat-form-field class="w-full" [subscriptSizing]="'dynamic'">
                            <mat-label>Gender</mat-label>
                            <mat-icon matPrefix class="hidden sm:flex icon-size-5" [svgIcon]="'heroicons_solid:user'"></mat-icon>
                            <input matInput [formControlName]="'gender'" [placeholder]="'Gender'" [spellcheck]="false">
                        </mat-form-field>
                    </div>
                    <div class="mt-8">
                        <mat-form-field class="w-full" [subscriptSizing]="'dynamic'">
                            <mat-label>Age Group</mat-label>
                            <mat-icon matPrefix class="hidden sm:flex icon-size-5" [svgIcon]="'heroicons_solid:user-group'"></mat-icon>
                            <input matInput [formControlName]="'age_group'" [placeholder]="'Age Group'" [spellcheck]="false">
                        </mat-form-field>
                    </div>
                    <div class="mt-8">
                        <mat-form-field class="w-full" [subscriptSizing]="'dynamic'">
                            <mat-label>Date</mat-label>
                            <mat-icon matPrefix class="hidden sm:flex icon-size-5" [svgIcon]="'heroicons_solid:calendar'"></mat-icon>
                            <input matInput [formControlName]="'date'" [matDatepicker]="datePicker" [placeholder]="'Date'">
                            <mat-datepicker-toggle matSuffix [for]="datePicker"></mat-datepicker-toggle>
                            <mat-datepicker #datePicker></mat-datepicker>
                        </mat-form-field>
                    </div>
                    <div class="mt-8">
                        <mat-form-field class="w-full" [subscriptSizing]="'dynamic'">
                            <mat-label>Invited By</mat-label>
                            <mat-icon matPrefix class="hidden sm:flex icon-size-5" [svgIcon]="'heroicons_solid:user'"></mat-icon>
                            <input matInput [formControlName]="'invited_by'" [placeholder]="'Invited By'" [spellcheck]="false">
                        </mat-form-field>
                    </div>
                    <div class="mt-8">
                        <mat-checkbox [formControlName]="'first_time_visitor'">First Time Visitor</mat-checkbox>
                    </div>
                    <div class="mt-8">
                        <mat-checkbox [formControlName]="'returning_visitor'">Returning Visitor</mat-checkbox>
                    </div>
                    <div class="mt-8">
                        <mat-checkbox [formControlName]="'new_to_area'">New to Area</mat-checkbox>
                    </div>
                    <ng-container formGroupName="visitation">
                        <div class="mt-8">
                            <mat-form-field class="w-full" [subscriptSizing]="'dynamic'">
                                <mat-label>Day of Visit</mat-label>
                                <mat-icon matPrefix class="hidden sm:flex icon-size-5" [svgIcon]="'heroicons_solid:calendar'"></mat-icon>
                                <input matInput formControlName="day_of_visit" placeholder="Day of Visit" spellcheck="false">
                            </mat-form-field>
                        </div>
                        <div class="mt-8">
                            <mat-form-field class="w-full" [subscriptSizing]="'dynamic'">
                                <mat-label>Time of Visit</mat-label>
                                <mat-icon matPrefix class="hidden sm:flex icon-size-5" [svgIcon]="'heroicons_solid:clock'"></mat-icon>
                                <input matInput formControlName="time_of_visit" placeholder="Time of Visit" spellcheck="false">
                            </mat-form-field>
                        </div>
                    </ng-container>
                    <ng-container formGroupName="communication_tool">
                        <div class="mt-8">
                            <mat-checkbox formControlName="telephone_call">Telephone Call</mat-checkbox>
                        </div>
                        <div class="mt-8">
                            <mat-checkbox formControlName="sms_whatsapp">SMS/WhatsApp</mat-checkbox>
                        </div>
                    </ng-container>
                    <div class="mt-8">
                        <div class="space-y-4">
                            <ng-container *ngFor="let email of contactForm.get('emails')['controls']; let i = index; let first = first; let last = last; trackBy: trackByFn">
                                <div class="flex">
                                    <mat-form-field class="flex-auto" [subscriptSizing]="'dynamic'">
                                        <mat-label *ngIf="first">Email</mat-label>
                                        <mat-icon matPrefix class="hidden sm:flex icon-size-5" [svgIcon]="'heroicons_solid:envelope'"></mat-icon>
                                        <input matInput [formControl]="email.get('email')" [placeholder]="'Email address'" [spellcheck]="false">
                                    </mat-form-field>
                                    <mat-form-field class="flex-auto w-full max-w-24 sm:max-w-40 ml-2 sm:ml-4" [subscriptSizing]="'dynamic'">
                                        <mat-label *ngIf="first">Label</mat-label>
                                        <mat-icon matPrefix class="hidden sm:flex icon-size-5" [svgIcon]="'heroicons_solid:tag'"></mat-icon>
                                        <input matInput [formControl]="email.get('label')" [placeholder]="'Label'">
                                    </mat-form-field>
                                    <ng-container *ngIf="!(first && last)">
                                        <div class="flex items-center w-10 pl-2" [ngClass]="{'mt-6': first}">
                                            <button class="w-8 h-8 min-h-8" mat-icon-button (click)="removeEmailField(i)" matTooltip="Remove">
                                                <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:trash'"></mat-icon>
                                            </button>
                                        </div>
                                    </ng-container>
                                </div>
                            </ng-container>
                        </div>
                        <div class="group inline-flex items-center mt-2 -ml-4 py-2 px-4 rounded cursor-pointer" (click)="addEmailField()">
                            <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:plus-circle'"></mat-icon>
                            <span class="ml-2 font-medium text-secondary group-hover:underline">Add an email address</span>
                        </div>
                    </div>
                    <div class="mt-8">
                        <div class="space-y-4">
                            <ng-container *ngFor="let phoneNumber of contactForm.get('phoneNumbers')['controls']; let i = index; let first = first; let last = last; trackBy: trackByFn">
                                <div class="relative flex">
                                    <mat-form-field class="flex-auto" [subscriptSizing]="'dynamic'">
                                        <mat-label *ngIf="first">Phone</mat-label>
                                        <input matInput [formControl]="phoneNumber.get('phoneNumber')" [placeholder]="'Phone'">
                                        
                                    </mat-form-field>
                                    <mat-form-field class="flex-auto w-full max-w-24 sm:max-w-40 ml-2 sm:ml-4" [subscriptSizing]="'dynamic'">
                                        <mat-label *ngIf="first">Label</mat-label>
                                        <mat-icon matPrefix class="hidden sm:flex icon-size-5" [svgIcon]="'heroicons_solid:tag'"></mat-icon>
                                        <input matInput [formControl]="phoneNumber.get('label')" [placeholder]="'Label'">
                                    </mat-form-field>
                                    <ng-container *ngIf="!(first && last)">
                                        <div class="flex items-center w-10 pl-2" [ngClass]="{'mt-6': first}">
                                            <button class="w-8 h-8 min-h-8" mat-icon-button (click)="removePhoneNumberField(i)" matTooltip="Remove">
                                                <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:trash'"></mat-icon>
                                            </button>
                                        </div>
                                    </ng-container>
                                </div>
                            </ng-container>
                        </div>
                        <div class="group inline-flex items-center mt-2 -ml-4 py-2 px-4 rounded cursor-pointer" (click)="addPhoneNumberField()">
                            <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:plus-circle'"></mat-icon>
                            <span class="ml-2 font-medium text-secondary group-hover:underline">Add a phone number</span>
                        </div>
                    </div>
                    <div class="mt-8">
                        <mat-form-field class="w-full" [subscriptSizing]="'dynamic'">
                            <mat-label>Address</mat-label>
                            <mat-icon matPrefix class="hidden sm:flex icon-size-5" [svgIcon]="'heroicons_solid:map-pin'"></mat-icon>
                            <input matInput [formControlName]="'address'" [placeholder]="'Address'">
                        </mat-form-field>
                    </div>
                    <div class="mt-8">
                        <mat-form-field class="w-full" [subscriptSizing]="'dynamic'">
                            <mat-label>Birthday</mat-label>
                            <mat-icon matPrefix class="hidden sm:flex icon-size-5" [svgIcon]="'heroicons_solid:cake'"></mat-icon>
                            <input matInput [matDatepicker]="birthdayDatepicker" [formControlName]="'birthday'" [placeholder]="'Birthday'">
                            <mat-datepicker-toggle matSuffix [for]="birthdayDatepicker"></mat-datepicker-toggle>
                            <mat-datepicker #birthdayDatepicker></mat-datepicker>
                        </mat-form-field>
                    </div>
                    <div class="mt-8">
                        <mat-form-field class="w-full" [subscriptSizing]="'dynamic'">
                            <mat-label>Notes</mat-label>
                            <mat-icon matPrefix class="hidden sm:flex icon-size-5" [svgIcon]="'heroicons_solid:bars-3-bottom-left'"></mat-icon>
                            <textarea matInput [formControlName]="'notes'" [placeholder]="'Notes'" [rows]="5" [spellcheck]="false" cdkTextareaAutosize></textarea>
                        </mat-form-field>
                    </div>
                    <div class="flex items-center mt-10 -mx-6 sm:-mx-12 py-4 pr-4 pl-1 sm:pr-12 sm:pl-7 border-t bg-gray-50 dark:bg-transparent">
                        <button mat-button [color]="'warn'" [matTooltip]="'Delete'" (click)="deleteContact()">Delete</button>
                        <button class="ml-auto" mat-button [matTooltip]="'Cancel'" (click)="toggleEditMode(false)">Cancel</button>
                        <button class="ml-2" mat-flat-button [color]="'primary'" [disabled]="contactForm.invalid" [matTooltip]="'Save'" (click)="updateContact()">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </ng-container>
</div>
